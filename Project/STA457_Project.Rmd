---
title: "STA457 Project"
author: "Xing Yu Wang"
date: "2025-03-29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
# install.packages("forecast")
# install.packages("astsa")
# install.packages("Metrics")
install.packages("xgboost")

library(dplyr)
library(tidyverse)
library(readr)
library(lubridate)
library(forecast)
library(astsa)
library(tseries)
library(mgcv)
library(Metrics)
library(ggplot2)
library(xgboost)
library(XGBClassifier)
```


# 1. EDA
```{r}
price = read.csv("./Daily Prices_ICCO.csv")
weather = read.csv("./Ghana_data.csv")
```

## 1.1 Clean Data
```{r}
weather <- weather |> select(DATE, TAVG)
exchangerate <- USD_GHS_Historical_Data |> select(Date, Price)
```

```{r}
colnames(price)[colnames(price) == 'ICCO.daily.price..US..tonne.'] <- 'Daily_Price'
colnames(weather)[colnames(weather) == 'DATE'] <- 'Date'
colnames(weather)[colnames(weather) == 'TAVG'] <- 'Avg_Temp'
colnames(exchangerate)[colnames(exchangerate) == 'Price'] <- 'exchange_rate'
```

## 1.2 Check duplicated values
```{r}
price |> group_by(Date) |> filter(n() > 1) |> ungroup()
```

```{r}
price <- price |> filter(!(Date == "31/01/2024" & Daily_Price == "10,888.05"))
price <- price |> filter(!(Date == "30/01/2024" & Daily_Price == "10,676.42"))
price <- distinct(price)
```

## 1.3 Convert to Time Series Data
### 1.3.1 price Dataset
```{r}
price$Date <- as.Date(price$Date, format="%d/%m/%Y")
price$Daily_Price <- as.numeric(gsub(",", "", price$Daily_Price))
price_month <- price |> mutate(Time = floor_date(Date, "month")) |> group_by(Time) |> 
  summarise(month_Price = mean(Daily_Price, na.rm = TRUE)) |> ungroup()
```

```{r}
summary(price)
```

```{r}
price_ts <- ts(price_month$month_Price, start = c(1994, 11), end = c(2024, 11), frequency = 12)
```

```{r}
plot(price_ts, main="Monthly Price Time Series", ylab="Price", xlab="Time")
```

```{r}
acf2(price_ts, 50)
```

```{r}
ndiffs(price_ts)
```

```{r}
price_month$price_log <- log(price_month$month_Price)
diff_log_price = diff(price_month$price_log)
```

```{r}
ts.plot(diff_log_price, main = "Log Differenced Price Data", ylab = "Log Differenced Price")
```
```{r}
adf.test(diff_log_price)
```
```{r}
acf2(diff_log_price, 50)
```



### 1.3.2 ghana Dataset
```{r}
weather$Date <- as.Date(weather$Date)
weather$Avg_Temp <- as.numeric(gsub("", "", weather$Avg_Temp))
weather_month <- weather |> mutate(Time = floor_date(Date, "month")) |> group_by(Time) |> 
  summarise(Avg_Temp = mean(Avg_Temp, na.rm = TRUE)) |> ungroup()
```

```{r}
summary(weather_month)
```

```{r}
weather_ts <- ts(weather_month$Avg_Temp, start = c(1994, 11), end = c(2024, 11), frequency = 12)
```

```{r}
ts.plot(weather_ts, main="Monthly Average Temperature Time Series", ylab="Temperature", xlab="Time")
```

## exchange Data
```{r}
exchangerate$Date <- as.Date(exchangerate$Date)
exchangerate$exchange_rate <- as.numeric(gsub("", "", exchangerate$exchange_rate))
rate_month <- exchangerate |> mutate(Time = floor_date(Date, "month")) |> group_by(Time) |> 
  summarise(exchange_rate = mean(exchange_rate, na.rm = TRUE)) |> ungroup()
```

```{r}
summary(exchangerate)
```

```{r}
rate_ts <- ts(rate_month$exchange_rate, start = c(1994, 11), end = c(2024, 11), frequency = 12)
```

```{r}
ts.plot(rate_ts, main="Monthly Average Exchange Rate Time Series", ylab="Exchange Rate (USD/GHS)", xlab="Time")
```

```{r}
par(mfrow=c(3,1), mar = c(3, 4, 2, 2))
# price
plot(price_ts, main="Monthly Price Time Series", ylab="Price", xlab="Time")
#temperature
ts.plot(weather_ts, main="Monthly Average Temperature Time Series", ylab="Temperature", xlab="Time")
# exchange rate
ts.plot(rate_ts, main="Monthly Average Exchange Rate Time Series", ylab="Exchange Rate (USD/GHS)", xlab="Time")
```

```{r}
plot(data$Avg_Temp, data$month_Price, xlab = "Monthly Price", ylab = "Average Temperature", 
     main = "Daily Price vs. Avg Temperature")
```
```{r}
pairs(data[, c("month_Price", "Avg_Temp", "exchange_rate")])
```

## Combine and Split data
```{r}
data <- price_month |> left_join(weather_month, by = "Time") |> left_join(rate_month, by = "Time")
data <- data |> mutate(log_price = log(month_Price), diff_log_price = 
                         c(NA, diff(price_month$price_log))) |> drop_na()
data <- data |> select(Time, Avg_Temp, exchange_rate, diff_log_price, log_price, month_Price)

data$Time <- as.Date(data$Time)
```

```{r}
data <- data[order(data$Time), ]
cutoff <- floor(0.7 * nrow(data))
trainSet <- data[1:cutoff, ]
testSet <- data[(cutoff+1):nrow(data), ]
```

```{r}
data_train_ts <- ts(trainSet$diff_log_price, frequency = 12)
```


# 2. Method
## 2.1 ETS Model
ETS is a purely univariate model and cannot directly handle external regressors.
```{r}
plot(ets_model)
```


### 2.1.1 Fit Model
```{r}
ets_model <- ets(data_train_ts, model = "ANA")
ets_zmodel <- ets(data_train_ts, model = "ZZZ") # Automatically selects best model
summary(ets_model)
summary(ets_zmodel)
```


<<<<<<< HEAD
### 2.1.2 Forecasting and Plotting
```{r}
# Plot using log differenced price
data_test_ts <- ts(testSet$diff_log_price, start = end(data_train_ts) + c(0,1), 
                   frequency = 12)

h <- nrow(testSet)
forecast_ets <- forecast(ets_model, h = h)

autoplot(forecast_ets) + autolayer(data_test_ts, series = "Actual", color = "red")
```
The red line is the observed actual values. The forecasted values are the central blue line within the blue shaded prediction intervals.

```{r}
last_log_price <- tail(trainSet$log_price, 1)

# Convert back to actual price
forecasted_price <- exp(cumsum(forecast_ets$mean) + last_log_price)

actual_price <- exp(testSet$log_price)
```

```{r}
data_test_ts <- ts(testSet$diff_log_price, start = end(data_train_ts) + c(0,1), 
                   frequency = 12)

forecast_ets_ts <- ts(forecasted_price, start = start(data_test_ts), frequency = 12)
actual_ets_ts <- ts(actual_price, start = start(data_test_ts), frequency = 12)
```

```{r}
# Plot using actual price
autoplot(forecast_ets_ts, series = "Predicted") + 
  autolayer(actual_ets_ts, series = "Actual", color = "blue") +
  ggtitle("Forecast vs Actual Prices") +
  ylab("Price") +
  xlab("Time") +
  theme_minimal()
```
```{r}
checkresiduals(ets_model)
checkresiduals(ets_zmodel)
```




=======
## 2.2 ARIMA Model
>>>>>>> c2884286efa75e995485ea3383a0f60ac38f463b

## 2.3 SARIMA Model

## 2.4 ARMAX Model

## 2.5 GAM Model
### 2.5.1 Fit Model
```{r}
trainSet$Time = as.Date(trainSet$Time)
trainSet$monthFac = as.factor(format(trainSet$Time, "%m"))
# trainSet$month_num = as.numeric(trainSet$monthFac)
# trainSet$timeNumeric = as.numeric(trainSet$date)
trainSet$Ndays = days_in_month(trainSet$Time)
trainSet$logdays = log(trainSet$Ndays)

gam_model <- gam(diff_log_price ~ s(as.numeric(Time), k=12) + s(Avg_Temp) + s(exchange_rate) +
                   s(monthFac, bs = "re") + sinpi(yday(Time) / 182.625) + 
                   cospi(yday(Time) / 182.625) + sinpi(yday(Time) / 91.3125) + 
                   cospi(yday(Time) / 91.3125) + offset(logdays),
                   data = trainSet, method = "ML", family = gaussian())

gam_model2 <- gam(diff_log_price ~ s(as.numeric(Time), k=100) + s(Avg_Temp) + 
                   s(log(exchange_rate)) + s(monthFac, bs = "re") + sinpi(yday(Time) / 182.625) + 
                   cospi(yday(Time) / 182.625) + sinpi(yday(Time) / 91.3125) + 
                   cospi(yday(Time) / 91.3125) + offset(logdays),
                   data = trainSet, method = "REML")

gam_model3 <- gam(diff_log_price ~ s(as.numeric(Time), k=100) + s(Avg_Temp) + 
                   s(log(exchange_rate)) + s(monthFac, bs = "re") + 
                    s(yday(Time), bs = "cc", k = 10) + offset(logdays),
                   data = trainSet, method = "REML")
```

```{r}
gam.check(gam_model)
gam.check(gam_model2)
gam.check(gam_model3)
```
```{r}
summary(gam_model)
summary(gam_model2)
summary(gam_model3)
```

### 2.5.2 Forecast and Plot
```{r}
testSet$Time = as.Date(testSet$Time)
testSet$monthFac = as.factor(format(testSet$Time, "%m"))
# trainSet$month_num = as.numeric(trainSet$monthFac)
# trainSet$timeNumeric = as.numeric(trainSet$date)
testSet$Ndays = days_in_month(testSet$Time)
testSet$logdays = log(testSet$Ndays)

testSet2 <- testSet
testSet2$log_exchange_rate <- log(testSet2$exchange_rate)
```

```{r}
# gam1
testSet$pred_log <- predict(gam_model, newdata = testSet)
testSet$pred_log_price <- last_log_price + cumsum(testSet$pred_log)
testSet$pred_price <- exp(testSet$pred_log_price)

# gam2
testSet2$pred_log2 <- predict(gam_model2, newdata = testSet2)
testSet2$pred_log_price2 <- last_log_price + cumsum(testSet2$pred_log2)
testSet2$pred_price2 <- exp(testSet2$pred_log_price2)

# gam3
testSet2$pred_log3 <- predict(gam_model3, newdata = testSet2)
testSet2$pred_log_price3 <- last_log_price + cumsum(testSet2$pred_log3)
testSet2$pred_price3 <- exp(testSet2$pred_log_price3)
```

```{r}
## DO NOT KEEP

# gam1
preds <- predict(gam_model, newdata = testSet, se.fit = TRUE)

testSet$pred_log <- preds$fit
testSet$pred_log_upper <- preds$fit + 1.96 * preds$se.fit
testSet$pred_log_lower <- preds$fit - 1.96 * preds$se.fit

testSet$pred_log_price <- last_log_price + cumsum(testSet$pred_log)
testSet$pred_price <- exp(testSet$pred_log_price)

testSet$pred_log_price_upper <- last_log_price + cumsum(testSet$pred_log_upper)
testSet$pred_price_upper <- exp(testSet$pred_log_price_upper)

testSet$pred_log_price_lower <- last_log_price + cumsum(testSet$pred_log_lower)
testSet$pred_price_lower <- exp(testSet$pred_log_price_lower)

# gam2
preds2 <- predict(gam_model2, newdata = testSet, se.fit = TRUE)

testSet$pred_log2 <- preds2$fit
testSet$pred_log_upper2 <- preds2$fit + 1.96 * preds2$se.fit
testSet$pred_log_lower2 <- preds2$fit - 1.96 * preds2$se.fit

testSet$pred_log_price2 <- last_log_price + cumsum(testSet$pred_log2)
testSet$pred_price2 <- exp(testSet$pred_log_price2)

testSet$pred_log_price_upper2 <- last_log_price + cumsum(testSet$pred_log_upper2)
testSet$pred_price_upper2 <- exp(testSet$pred_log_price_upper2)

testSet$pred_log_price_lower2 <- last_log_price + cumsum(testSet$pred_log_lower2)
testSet$pred_price_lower2 <- exp(testSet$pred_log_price_lower2)

# gam3
preds3 <- predict(gam_model3, newdata = testSet, se.fit = TRUE)

testSet$pred_log3 <- preds3$fit
testSet$pred_log_upper3 <- preds3$fit + 1.96 * preds3$se.fit
testSet$pred_log_lower3 <- preds3$fit - 1.96 * preds3$se.fit

testSet$pred_log_price3 <- last_log_price + cumsum(testSet$pred_log3)
testSet$pred_price3 <- exp(testSet$pred_log_price3)

testSet$pred_log_price_upper3 <- last_log_price + cumsum(testSet$pred_log_upper3)
testSet$pred_price_upper3 <- exp(testSet$pred_log_price_upper3)

testSet$pred_log_price_lower3 <- last_log_price + cumsum(testSet$pred_log_lower3)
testSet$pred_price_lower3 <- exp(testSet$pred_log_price_lower3)
```

```{r}
## DO NOT KEEP

ggplot(testSet, aes(x = Time)) +
  geom_line(aes(y = month_Price, color = "Actual"), size = 1) +
  geom_line(aes(y = pred_price, color = "Predicted"), size = 1) +
  geom_line(aes(y = pred_price_upper), linetype = "dashed", color = "blue") +
  geom_line(aes(y = pred_price_lower), linetype = "dashed", color = "blue") +
  labs(title = "Actual vs. Predicted Price with 95% Prediction Interval",
       x = "Time", y = "Price") +
  scale_color_manual(values = c("Actual" = "black", "Predicted" = "red")) +
  theme_minimal()
```

```{r}
ggplot(testSet, aes(x = Time)) +
  geom_line(aes(y = month_Price, color = "Actual")) +
  geom_line(aes(y = pred_price, color = "Predicted")) +
  labs(title = "Actual vs. Predicted Price", 
       x = "Time", y = "Price") +
  scale_color_manual(values = c("Actual" = "black", "Predicted" = "red")) +
  theme_minimal()
```

```{r}
ggplot(testSet2, aes(x = Time)) +
  geom_line(aes(y = month_Price, color = "Actual")) +
  geom_line(aes(y = pred_price2, color = "Predicted")) +
  labs(title = "Actual vs. Predicted Price", 
       x = "Time", y = "Price") +
  scale_color_manual(values = c("Actual" = "black", "Predicted" = "red")) +
  theme_minimal()
```

```{r}
ggplot(testSet2, aes(x = Time)) +
  geom_line(aes(y = month_Price, color = "Actual")) +
  geom_line(aes(y = pred_price3, color = "Predicted")) +
  labs(title = "Actual vs. Predicted Price", 
       x = "Time", y = "Price") +
  scale_color_manual(values = c("Actual" = "black", "Predicted" = "red")) +
  theme_minimal()
```

```{r}
anova(gam_model, gam_model2, gam_model3)
```

```{r}
AIC(gam_model, gam_model2, gam_model3)
```


## 2.6 XGBoost Model
```{r}
trainSet$Lag1 <- lag(trainSet$diff_log_price, 1)
trainSet$Lag12 <- lag(trainSet$diff_log_price, 12)
testSet$Lag1 <- lag(testSet$diff_log_price, 1)
testSet$Lag12 <- lag(testSet$diff_log_price, 12)

predictors <- c("Time", "Avg_Temp", "exchange_rate", "Lag1", "Lag12")
target <- "diff_log_price"
```

```{r}
train_data <- trainSet[complete.cases(trainSet[, c(predictors, target)]), ]
test_data <- testSet[complete.cases(testSet[, predictors]), ]

train_data <- train_data |>
  mutate(across(all_of(predictors), as.numeric)) 
test_data <- test_data |>
  mutate(across(all_of(predictors), as.numeric))

# Convert to DMatrix (XGBoost's optimized format)
dtrain <- xgb.DMatrix(
  data = as.matrix(train_data[, predictors]),
  label = train_data[[target]]
)
```

```{r}
params <- list(
  objective = "reg:squarederror",  # For regression
  eta = 0.05,                      # Learning rate (lower for time series)
  max_depth = 6,                   # Tree depth (avoid overfitting)
  subsample = 0.8,                 # Random subset of data per tree
  colsample_bytree = 0.8,          # Random subset of features per tree
  gamma = 1,                       # Minimum loss reduction for splits
  min_child_weight = 5             # Prevent overfitting to small groups
)

set.seed(123)
xgb_model <- xgb.train(
  params,
  data = dtrain,
  nrounds = 1000,                  # Large number (early stopping will handle)
  watchlist = list(train = dtrain),
  early_stopping_rounds = 50,      # Stop if no improvement for 50 rounds
  print_every_n = 10
)
```

```{r}
dtest <- xgb.DMatrix(as.matrix(test_data[, predictors]))
test_data$pred_diff_log <- predict(xgb_model, dtest)

# Convert to actual price predictions
test_data <- test_data %>%
  mutate(
    pred_log_price = last_log_price + cumsum(pred_diff_log),  # Only if modeling differences
    pred_price = exp(pred_log_price)
  )
```

```{r}
ggplot(test_data, aes(x = Time)) +
  geom_line(aes(y = month_Price, color = "Actual")) +
  geom_line(aes(y = pred_price, color = "Predicted")) +
  labs(title = "XGBoost: Actual vs. Predicted Price",
       x = "Time", y = "Price") +
  scale_color_manual(values = c("Actual" = "black", "Predicted" = "red")) +
  theme_minimal()
```


```{r}
xgb = XGBClassifier(random_state=42)
xgb.fit(predictors, target)
```









